<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="description" content="A few years ago, I decided to adopt the practices of reproducible research as far as possible within the technical and social constraints I have to live with. So how reproducible is my published code over time?...">
    <meta name="author"      content="Konrad Hinsen">
    <meta name="keywords"    content="python, reproducible research">
    <link rel="icon"      href="/img/favicon.ico">
    <link rel="canonical" href="http://blog.khinsen.net/posts/2017/04/06/reproducible-research-in-the-python-ecosystem-a-reality-check/">

    <title>Reproducible research in the Python ecosystem: a reality check</title>

    <!-- Bootstrap core CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="/css/blog.css" rel="stylesheet">

    <!-- Custom styles for Frog-generated content -->
    <link rel="stylesheet" type="text/css" href="/css/pygments.css">
    <link rel="stylesheet" type="text/css" href="/css/scribble.css">
    <link rel="stylesheet" type="text/css" href="/css/custom.css">

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <script src="/js/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script>
       window.hypothesisConfig = function () {
         return { showHighlights : true };
       };
       </script>
       <script defer src="https://hypothes.is/embed.js"></script>
  </head>

  <body>

    <div class="blog-masthead">
      <div class="container">
        <nav class="blog-nav">
          <a class="blog-nav-item" href="/index.html">Home</a>
          <a class="blog-nav-item" href="/feeds/all.atom.xml">Atom</a>
          <a class="blog-nav-item" href="/feeds/all.rss.xml">RSS</a>
        </nav>
      </div>
    </div>

    <div class="container">

      <div class="blog-header">
        <h2 class="blog-title">Konrad Hinsen's Blog</h2>
      </div>

      <div class="row">

        <div class="col-sm-8 blog-main">


          <div class="blog-post">

  <h3 class="blog-post-title"><a href='/posts/2017/04/06/reproducible-research-in-the-python-ecosystem-a-reality-check/'>Reproducible research in the Python ecosystem: a reality check</a></h3>
  <p class="blog-post-meta">
<time datetime="2017-04-06" pubdate="true">2017-04-06</time> :: <span class="tags"><a href="/tags/python.html">python</a>, <a href="/tags/reproducible-research.html">reproducible research</a></span></p>

<p>A few years ago, I decided to adopt the practices of reproducible research as far as possible within the technical and social constraints I have to live with. So how reproducible is my published code over time?</p>
<!-- more-->

<p>The example I have chosen for this reproducibility study is a 2013 paper about computing diffusion coefficients from molecular simulations. <a href="https://doi.org/10.6084/m9.figshare.808594.v1">All code and data</a> has been published as an <a href="http://www.activepapers.org/">ActivePaper</a> on <a href="https://figshare.com/">figshare</a>. To save space, intermediate results had been removed from the published archive. This makes my reproducibility check very straightforward: a simple <code>aptool update</code> will recompute everything starting from these intermediate results up to the plots that went into <a href="http://dx.doi.org/10.1063/1.4823996">the paper</a>.</p>

<p>One nice aspect of ActivePapers is that it stores the version numbers of all dependencies, so I can quickly verify that in 2013, I had used Python 2.7.3, NumPy 1.6.2, h5py 2.1.3, and matplotlib 1.2.x (yes, the x is part of the reported version number).</p>

<h2 id="first-try-use-my-current-python-environment">First try: use my current Python environment</h2>

<p>The evironment in which I do most of my current research has Python 3.5.2, NumPy 1.11.1, h5py 2.6, and Matplotlib 1.5.1. I set it up about a year ago when I got a new laptop, and haven&rsquo;t had a good reason to update it since then. I had made some effort back in 2013 to make my code compatible with Python 3, so why not try now if this was a worthy investment?</p>

<p>Outcome: running the computations works just fine, with results that are not identical at the bit level but close enough for my application. However, I get some warnings from matplotlib when generating the plots. Here is the first one, the others are similar:</p>

<pre><code>UserWarning: Legend does not support 'x' instances.
A proxy artist may be used instead.
See: http://matplotlib.org/users/legend_guide.html#using-proxy-artist
  "#using-proxy-artist".format(orig_handle)</code></pre>

<p>A quick inspection of the plots shows that the legends have almost disappeared, all that&rsquo;s left is a small white box. That makes many of the plots unintellegible.</p>

<p>Just out of curiosity, I made a quick attempt to figure out the error message. What&rsquo;s that &lsquo;x&rsquo; instance? The following messages also refer to &lsquo;yz&rsquo; instances and a few others. A look at my script reveals that &lsquo;x&rsquo;, &lsquo;yz&rsquo; etc. are in fact the strings that I supplied as legends. Sounds strange to call them &lsquo;x&rsquo; instances, as if &lsquo;x&rsquo; were a class. And what&rsquo;s that cryptic reference to a proxy artist?</p>

<p>Better stop here: my goal was to see if I can reproduce my data and figures from 2013 in a Python environment from 2016, and the answer is no. The plots are mutilated to the point of no longer being useful.</p>

<h2 id="second-try-use-my-current-python-27-environment">Second try: use my current Python 2.7 environment</h2>

<p>Some of my research code still lives in the Python 2.7 universe, so I also have a Python environment based on Python 2.7.11 on my laptop, with NumPy 1.8.2, h5py 2.5, and matplotlib 1.4.3. That&rsquo;s much closer to the original one, so let&rsquo;s see how well it does in my reproducibility evaluation.</p>

<p>Outcome: Much better. The computations work fine as before, and the plots generate a single warning:</p>

<pre><code>MatplotlibDeprecationWarning: The "loc" positional argument to legend is deprecated. Please use the "loc" keyword instead.</code></pre>

<p>The legends still look OK, so the warning is just a minor nuisance, as one would expect from a deprecation-related message. Interestingly, this warning is also about legends, so it looks like there was a serious backwards-incompatible change in matplotlib&rsquo;s <code>legend</code> function between 1.2 and 1.5, which was prepared by a deprecation warning in 1.4.</p>

<h2 id="third-try-reconstructing-the-original-environment">Third try: reconstructing the original environment</h2>

<p>Since I have the version numbers of everything, why not try to reconstruct the original environment exactly? Let&rsquo;s go for the same major and minor version numbers, which should be sufficient. That&rsquo;s a job for Anaconda:</p>

<pre><code>conda create -n python2013 python=2.7 numpy=1.6 h5py=2.1 matplotlib=1.2 anaconda
source active python2013
pip install tempdir
pip install ActivePapers.Py</code></pre>

<p>Outcome: no warnings, no errors. Identical results. Reproducibility bliss at its best.</p>

<h2 id="conclusions">Conclusions</h2>

<p>In summary, my little experiment has shown that reproducibility of Python scripts requires preserving the original environment, which fortunately is not so difficult over a time span of four years, at least if everything you need is part of the Anaconda distribution. I am not sure I would have had the patience to reinstall everything from source, given <a href="http://blog.khinsen.net/posts/2015/11/06/a-rant-about-software-deployment-in-2015/">an earlier bad experience</a>.</p>

<p>The purely computational part of my code was even surprisingly robust under updates in its dependencies. But the plotting code wasn&rsquo;t, as matplotlib has introduced backwards-incompatible changes in a widely used function. Clearly the matplotlib team prepared this carefully, introducing a deprecation warning before introducing the breaking change. For properly maintained client code, this can probably be dealt with.</p>

<p>The problem is that I do not intend to maintain the plotting scripts for all the papers I publish. And that&rsquo;s not only out of laziness, but because doing so would violate the spirit of reproducible research. The code I publish is exactly the code that I used for the original work, without any modification. If I started maintaining it, I could easily change the results by accident. I&rsquo;d thus have to introduce regression tests as a safeguard against such changes. But&hellip; how do I test for visual equivalence of plots? Bitwise reproducibility is about as realistic to expect for image files as for floating-point numbers: I don&rsquo;t even get bitwise identical image files running the same Python code with identical matplotlib versions on different machines.</p>

<p>For my next paper, I will look for alternatives to matplotlib. My plotting needs are rather basic, so perhaps there is some other library with a more stable API that is good enough for me. Suggestions are welcome!</p>

  <hr>

  <script type="text/javascript">
    !function(d,s,id){
        var js,fjs=d.getElementsByTagName(s)[0];
        if(!d.getElementById(id)){
            js=d.createElement(s);
            js.id=id;
            js.src="//platform.twitter.com/widgets.js";
            fjs.parentNode.insertBefore(js,fjs);
        }
    }(document,"script","twitter-wjs");
  </script>
  <a href="https://twitter.com/share"
     class="twitter-share-button"
     data-url="http://blog.khinsen.net/posts/2017/04/06/reproducible-research-in-the-python-ecosystem-a-reality-check/"
     data-dnt="true">
    "Tweet"</a>

  <div id="disqus_thread"></div>
  <script>
      /**
       *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
       *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
       */
      var disqus_config = function () {
          this.page.url = 'http://blog.khinsen.net/posts/2017/04/06/reproducible-research-in-the-python-ecosystem-a-reality-check/';
          this.page.identifier = '/posts/2017/04/06/reproducible-research-in-the-python-ecosystem-a-reality-check/';
      };
      (function() {  // DON'T EDIT BELOW THIS LINE
          var d = document, s = d.createElement('script');

          s.src = '//khinsen.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
      })();
  </script>

  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

  <ul class="pager">
  <li class="previous">
    <a href="/posts/2017/05/04/which-mistakes-do-we-actually-make-in-scientific-code/">&larr; <em>Which mistakes do we actually make in scientific code?</em></a>
  </li>
  <li class="next">
    <a href="/posts/2017/01/24/reproducibility-does-not-imply-reproduction/"><em>Reproducibility does not imply reproduction</em> &rarr;</a>
  </li>
  </ul>

</div><!-- /.blog-post -->

          <!-- <nav> -->
          <!--   <ul class="pager"> -->
          <!--     <li><a href="/posts/2017/05/04/which-mistakes-do-we-actually-make-in-scientific-code/">Previous</a></li> -->
          <!--     <li><a href="/posts/2017/01/24/reproducibility-does-not-imply-reproduction/">Next</a></li> -->
          <!--   </ul> -->
          <!-- </nav> -->

        </div><!-- /.blog-main -->

        <div class="col-sm-3 col-sm-offset-1 blog-sidebar">
          <div class="sidebar-module sidebar-module-inset">
            <h4>Note</h4>
            <p>This blog starts in November 2015. For older posts, see my
               <a href="http://khinsen.wordpress.com/">old WordPress blog</a>.
            </p>
          </div>
          <div class="sidebar-module">
            <h4>Tags</h4>
            <ol class="list-unstyled">
               <li><a href="/index.html">All Posts</a></li>

<li><a href="/tags/computational-science.html">computational science</a></li>

<li><a href="/tags/computer-aided-research.html">computer-aided research</a></li>

<li><a href="/tags/python.html">python</a></li>

<li><a href="/tags/reproducible-research.html">reproducible research</a></li>

<li><a href="/tags/science.html">science</a></li>

<li><a href="/tags/scientific-computing.html">scientific computing</a></li>

<li><a href="/tags/scientific-software.html">scientific software</a></li>

<li><a href="/tags/sustainable-software.html">sustainable software</a></li>
            </ol>
          </div>
          <div class="sidebar-module">
            <h4>Find me elsewhere</h4>
            <ol class="list-unstyled">
              <li><a href="http://khinsen.net">Home Page</a></li>
              <li><a href="http://twitter.com/khinsen/">Twitter</a></li>
              <li><a href="http://github.com/khinsen/">GitHub</a></li>
              <li><a href="http://bitbucket.org/khinsen">Bitbucket</a></li>
              <li><a href="http://orcid.org/0000-0003-0330-9428">ORCID</a></li>               <li><a href="http://www.researchgate.net/profile/Konrad_Hinsen">ResearchGate</a></li>

            </ol>
          </div>
        </div><!-- /.blog-sidebar -->

      </div><!-- /.row -->

    </div><!-- /.container -->

    <footer class="blog-footer">
      <p>
        <a href="#">Back to top</a>
      </p>
    </footer>


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="js/ie10-viewport-bug-workaround.js"></script>
  </body>
</html>